<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='以往在使用 caffe 中遇到的部分问题记录。
'><title>Caffe使用问题记录</title>
<link rel=canonical href=/p/caffe%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/><link rel=stylesheet href=/scss/style.min.d8118f156935b64eca93aca758476adca858d2c47354971654d9bd2933a0e45f.css><meta property='og:title' content='Caffe使用问题记录'><meta property='og:description' content='以往在使用 caffe 中遇到的部分问题记录。
'><meta property='og:url' content='/p/caffe%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/'><meta property='og:site_name' content='次二小栈'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='caffe'><meta property='article:published_time' content='2018-08-07T00:00:00+00:00'><meta property='article:modified_time' content='2018-08-07T00:00:00+00:00'><meta name=twitter:title content="Caffe使用问题记录"><meta name=twitter:description content="以往在使用 caffe 中遇到的部分问题记录。
"><link rel="shortcut icon" href=/letter-l.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/easy-peasy_50UJjNJE17_hua2b247eca74a7b47aad15a4079221f7e_48600_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>次二小栈</a></h1><h2 class=site-description>现在可以公开的笔记</h2></div></header><ol class=social-menu><li><a href=https://github.com/Lamply target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/%E9%93%BE%E6%8E%A5/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#使用教程>使用教程</a><ol><li><a href=#tldr>TL;DR</a></li><li><a href=#训练所需文件>训练所需文件</a></li><li><a href=#路径相关>路径相关</a></li><li><a href=#指令相关>指令相关</a></li><li><a href=#caffe-网络相关>Caffe 网络相关</a></li><li><a href=#关于分割网络的训练说明>关于分割网络的训练说明</a></li></ol></li><li><a href=#缺陷记录>缺陷记录</a></li><li><a href=#过程记录>过程记录</a></li><li><a href=#错误记录>错误记录</a></li><li><a href=#问题记录>问题记录</a></li><li><a href=#犯2记录>犯2记录</a></li><li><a href=#常见安装问题>常见安装问题</a></li><li><a href=#推荐安装方法>推荐安装方法</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E6%8A%80%E6%9C%AF%E7%BB%8F%E9%AA%8C/>技术经验
</a><a href=/categories/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/>问题记录</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/caffe%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/>Caffe使用问题记录</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 07, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 7 分钟</time></div></footer></div></header><section class=article-content><p>以往在使用 caffe 中遇到的部分问题记录。</p><h2 id=使用教程>使用教程</h2><p>Caffe 一般通过编译生成的可执行文件 caffe（一般路径为 <code>$CAFFE_PATH/build/tools/caffe</code>）来进行网络训练和测试。</p><h3 id=tldr>TL;DR</h3><ol><li>Python 调用（pycaffe 路径 <code>caffe/python/caffe</code>）</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>  <span class=kn>import</span> <span class=nn>caffe</span>
</span></span><span class=line><span class=cl>  <span class=n>net</span> <span class=o>=</span> <span class=n>caffe</span><span class=o>.</span><span class=n>Net</span><span class=p>(</span><span class=n>prototxt</span><span class=p>,</span> <span class=n>caffemodel</span><span class=p>,</span> <span class=n>TEST</span><span class=p>)</span> <span class=c1># 设置网络</span>
</span></span><span class=line><span class=cl>  <span class=n>net</span><span class=o>.</span><span class=n>blobs</span><span class=p>[</span><span class=s1>&#39;对应层的name&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=nb>input</span> <span class=c1># 操作输入输出</span>
</span></span><span class=line><span class=cl>  <span class=n>pred</span> <span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>foward</span><span class=p>()</span> <span class=c1># 前向取出最终层结果, 也可以通过  pred = net.blobs[&#39;name&#39;].data 来拿到</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>C++ 前向追踪：<br><code>net.cpp::Forward -> layer.hpp::Forward -> 各layer的Forward (src/caffe/layers/*.cpp & *.cu)</code></li></ol><p>自定义修改：</p><ol><li>自定义网络结构 ( 根据 <code>caffe.proto</code> ):<ul><li>改 <code>train.prototxt</code>、<code>solver.prototxt</code>、<code>test.prototxt</code></li></ul></li><li>自定义层:<ul><li>在 <code>src/caffe/layers/*</code> 下新增 .cpp、.cu</li><li>在 <code>include/caffe/layers*</code> 下新增 .hpp</li><li>改 <code>caffe.proto</code>，增加参数条目</li><li>部分复杂的子函数实现会放在 <code>src/caffe/util</code> 内</li></ul></li></ol><h3 id=训练所需文件>训练所需文件</h3><ul><li><code>*.prototxt</code>：用于定义网络结构的文件，一般在网络本身的基础上加入了训练和测试过程所需的网络模块，以及模块相应的训练和测试用参数。</li><li><code>*_deploy.prototxt</code>：同样是定义网络结构的文件，但只包含了前向推理部分，没有训练部分的模块和参数。</li><li><code>*_solver.prototxt</code>：用于训练和测试的配置文件，类似学习率、学习策略、惩罚项和输出信息等，可在 <code>$CAFFE_PATH/src/caffe/proto/caffe.proto</code> 中的 <code>SolverParameter</code> 找到具体配置项信息。</li></ul><p>上述文件的名字可随意更改，不过一般会加上这些后缀用以区分。</p><h3 id=路径相关>路径相关</h3><p>训练时需要指定 <code>*_solver.prototxt</code> 的路径，并在 <code>*_solver.prototxt</code> 指明网络 <code>*.prototxt</code> 的路径（也可以分开指定训练和测试用的网络），还需要定义输出模型以及状态的路径前缀 <code>snapshot_prefix</code>。<br>一般 <code>*.prototxt</code> 里还需要在输入数据层指明输入数据集的路径。</p><h3 id=指令相关>指令相关</h3><p>训练：（可以加上预训练模型 <code>-weights /路径/*.caffemodel</code> 或 恢复训练状态 <code>-snapshot /路径/*.solverstate</code>，<code>*.solverstate</code> 是在 <code>*.caffemodel</code> 基础上加上了训练的状态信息）</p><pre><code>$CAFFE_PATH/build/tools/caffe train -solver *_solver.prototxt
</code></pre><p>测试：（需要指定训练测试用的网络和训练好的模型，测试的样本数为 TEST_PHASE 的 <code>batch_size</code> x <code>iterations</code>）</p><pre><code>$CAFFE_PATH/build/tools/caffe test -model *.prototxt -weights *.caffemodel -iterations 100 -gpu 0
</code></pre><p>前向：用 python 接口调用 caffe 完成，基本流程形如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>caffe</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=o>=</span> <span class=n>caffe</span><span class=o>.</span><span class=n>Net</span><span class=p>(</span><span class=n>prototxt_path</span><span class=p>,</span> <span class=n>weights_path</span><span class=p>,</span> <span class=n>caffe</span><span class=o>.</span><span class=n>TEST</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=o>.</span><span class=n>blobs</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=n>input_image</span>
</span></span><span class=line><span class=cl><span class=n>net</span><span class=o>.</span><span class=n>forward</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>label</span> <span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>blobs</span><span class=p>[</span><span class=s1>&#39;label&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>data</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=caffe-网络相关>Caffe 网络相关</h3><p>Caffe 的网络 <code>Net</code> 是由各种层 <code>Layer</code> 组成的有向无环图，网络层通过 <code>Blob</code> 来存储 feature maps，具体层的实现在 <code>$CAFFE_PATH/src/caffe/layers/</code> 和 <code>$CAFFE_PATH/include/caffe/layers/</code> 里，其传递参数定义于 <code>$CAFFE_PATH/src/caffe/proto/caffe.proto</code>。网络结构文件中有什么看不懂或者需要深入了解的，找这三个地方就对了。</p><p>训练网络一般包含训练过程所需要的所有部分，比如数据输入层（如 Data Layer），Loss 层（如 SoftmaxWithLoss Layer），定义好后 Caffe 会自己输入数据然后计算输出 loss 并更新参数。前向网络同理。</p><p>如果需要用到 Caffe 没有的自定义网络层，需要自己编写相应 C++/CUDA 代码，放置于上述两个文件夹中，如果有传入参数还需要在 <code>caffe.proto</code> 中添加相应需要传入的参数配置。对于不好实现而且不需要 gpu 加速的自定义层，可以通过 python layer 来实现。</p><p>对于有复杂操作的网络，比如 loss 需要在外部计算，则可以通过 Caffe 的 python 接口实现，在 python 环境中做训练更新。</p><h3 id=关于分割网络的训练说明>关于分割网络的训练说明</h3><p>数据输入层 <code>DenseImageData</code> 是自定义层，在 <code>dense_image_data_param</code> 的 <code>source</code> 中指明了输入图片集的路径，txt 文件内的格式是：<br>&ldquo;样本图路径 标签路径&rdquo;</p><p>标签与样本图同等大小（224x224），单通道，其中像素值 0 为前景，1 为背景。</p><p>loss_s8、loss 的 class_weighting 为对应标签的 loss 权重，用于解决样本不平衡。class_weighting 计算方法：对所有数据集标签统计各类别个数，比如 0 的个数，1 的个数。<code>class_weighting_0 = num(1)/(num(1)+num(0))</code>、<code>class_weighting_1 = num(0)/(num(1)+num(0))</code>。</p><h2 id=缺陷记录>缺陷记录</h2><ul><li><code>Xavier</code>初始化没有乘上增益 (ReLU应乘根号2, 等等)</li><li>在matlab上训练得出的模型是col-major,需要将所有矩阵参数转置才能在其他地方用</li><li>老版本caffe在初次前向时会比较慢, 新版未知</li><li>caffe 初始化数据层时启动线程是 <strong>TEST</strong> 和 <strong>TRAIN</strong> 并行进行的, 即使将<code>test_initialization</code>设置为<code>false</code>也会进行一次__TEST__的数据 prefetch, 同样会进行<code>Transform</code>, 所以要注意相关的共享变量.</li><li>BatchNorm 的 eps 默认为 1e-5, 这个数值是 切实 会对结果产生一定影响的, 在 absorb 参数时也要注意</li></ul><h2 id=过程记录>过程记录</h2><ul><li>后向根据<code>top_diff</code>和前向结果算出各<code>blob</code>参数的<code>diff</code>, 以及<code>bottom</code>的<code>diff</code>, 所以分别对<code>blob</code>和<code>bottom</code>求导</li><li>传播时记得不同微分层乘上前面的梯度值<code>top_diff</code>,后传多个梯度值的话全部加起来</li><li><code>setup</code>是在加载网络时调用的, 加载完后不再调用</li></ul><h2 id=错误记录>错误记录</h2><ol><li>Check failed: data_</li></ol><ul><li>为 <code>blob shape</code> 错误, 一般是 <code>reshape</code> 函数出错, 也可能是网络设计错误导致 <code>shape</code> 传过来时负值错误</li></ul><h2 id=问题记录>问题记录</h2><ol><li>caffe模型测试时<code>batch_norm</code>层的use_global_stats设为false居然没影响???? 错觉</li><li>训练过程开始良好, 中途出现后方部分卷积开始死亡(参数值非常低), 然后向前传染, 大部分卷积死亡, 表现为验证集上非常不稳定<ul><li>推测是ReLU死亡</li></ul></li><li>caffe 和 opencv 一起 import 会出错<ul><li>added <code>-Wl,-Bstatic -lprotobuf -Wl,-Bdynamic</code> to <code>LDFLAGS</code> and removed <code>protobuf</code> from <code>LIBRARIES</code> ( 参照 <a class=link href=https://github.com/BVLC/caffe/issues/1917 target=_blank rel=noopener>https://github.com/BVLC/caffe/issues/1917</a> )</li></ul></li></ol><h2 id=犯2记录>犯2记录</h2><ol><li><code>resize</code>层或者叫<code>upsample</code> <code>upscale</code> 层, 若训练时使用的缩放算法不同, 在卷积到比较小的时候(4x4)之类的, 会由于策略差异导致缩放前后误差非差大</li><li>test 或 upgrade 时 model 和 prototxt 写反</li></ol><blockquote><p>[libprotobuf ERROR google/protobuf/text_format.cc:274] Error parsing text-format caffe.NetParameter: 2:1: Invalid control characters encountered in text.<br>&mldr;..<br>*** Check failure stack trace: ***<br>已放弃 (核心已转储)</p></blockquote><ol start=3><li>二分类问题 SoftmaxWithLoss 层不要设 ignore_label, ignore_label 是会忽略该 label 的 loss 和 diff 传递, 导致结果会完全倒向另一个 label , 因为 SoftmaxWithLoss 是计算准确率来算 loss 的</li></ol><h2 id=常见安装问题>常见安装问题</h2><ol><li><p>一般常见 protobuf 问题, 因为 Tensorflow 也用 protobuf, 不仅用, 还会自动升级 protobuf, 而 caffe 不怎么支持新版本的 protobuf, 所以如果配置了其他开源库的开发环境之后 caffe 报错了, 基本可以从几个方面检查 protobuf 有没问题.</p><ul><li><code>pip list</code>, 查看 protobuf 版本, 一般 2.6.1 比较通用, 如果是 3.5 那就换吧. 如果同时使用了 python2.7 和 python 3.5 的话那还要注意 pip 也分 pip2 和 pip3, 安装的库也分别独立. 可以在 <code>/usr/bin</code>, <code>/usr/local/bin</code>, <code>/$HOME/.local/bin</code> 下找到 pip 脚本, 打开就能看到它用的是 python2.7 还是 python3.5. ( <em>然后出现了下一个问题</em> )</li><li><code>protoc --version</code>, protobuf 依赖的东西, 查看它的版本和 protobuf 的是否一样, 不一样的话可以通过下载相应版本 release, 或者从源码安装 protobuf. 然后在 <code>/etc/ld.so.conf</code> 里面添加上一行 <code>/usr/local/lib</code>, 然后 <code>sudo ldconfig</code> 更新下链接库就行了. ( <em>然后出现了下一个问题</em> )</li><li><code>apt list | grep "protobuf"</code>, 有时候会有用 <code>apt-get install</code> 和 <code>pip install</code> 装了两种不同版本的 protobuf 的情况, 这时候可以 <code>apt</code> 删除并重新安装 protobuf ( <em>然后出现了下一个问题</em> )</li><li><code>File already exists in database: caffe.proto </code>, 库链接问题或者版本问题 ( 2.6.1 不好用 ), <code>pip uninstall protobuf</code> 删掉 protobuf, 重启, 加 -fPIC 到 configure, 然后 <code>./configure --disable-shared</code>, 然后在 protobuf 3.3 版本下 <code>cd $PROTOBUF_BUILD_DIR/python</code>, <code>python setup.py build</code>, <code>python setup.py test</code>, <code>python setup.py install</code> ( <em>然而出现了下一个问题</em> )<ul><li>还可能是 caffe 玄学问题, 总之最简单的就是直接把能用的 caffe 替换过来</li></ul></li><li><code>make all</code> 时出现一堆 protobuf 未定义的引用问题. ( <em>未解, 回溯 2.6.1</em> )</li><li>2.6.1:<ul><li><p><code>caffe_pb2.py: syntax error</code>, 注释掉默认 caffe 的 <code>python/caffe/proto/caffe_pb2.py</code>, 至于为什么项目 caffe 没有用自己的 <code>caffe_pb2.py</code> 而用到默认 caffe, 是因为没有成功 <code>make pycaffe</code> ??? 总之应该是版本问题.</p></li><li><p><code>File already exists in database: caffe.proto</code> 依旧存在这个问题, 在 <code>import caffe</code> 后 <code>import cv2</code> 会发生, 还是需要静态链接 protobuf, 这样可以解决:</p><ul><li><blockquote><p>linking caffe against libprotobuf.a instead of libprotobuf.so could solve this issue</p></blockquote></li><li><blockquote><p>I changed caffe&rsquo;s Makefile. Specifically, I added -Wl,-Bstatic -lprotobuf -Wl,-Bdynamic to LDFLAGS and removed protobuf from LIBRARIES.
I have uploaded my Makefile to gist (<a class=link href=https://gist.github.com/tianzhi0549/773c8dbc383c0cb80e7b%29 target=_blank rel=noopener>https://gist.github.com/tianzhi0549/773c8dbc383c0cb80e7b)</a>. You could check it out to see what changes I made (Line 172 and 369).</p></blockquote></li></ul></li><li><p><code>File "/usr/lib/python2.7/dist-packages/caffe/pycaffe.py", line 13, in &lt;module> from ._caffe import Net, SGDSolver, NesterovSolver, AdaGradSolver, libcaffe.so.1.0.0: cannot open shared object file: No such file or directory</code>. 这是 python 又喵了咪了用了默认 release 版 caffe, 删掉 <code>/usr/lib/python2.7/dist-packages/caffe</code>, 然后在工程头处 <code>import sys</code> 加<code>sys.path.insert('/home/sad/ENet/caffe-enet/python')</code> 和 <code>sys.path.insert('/home/sad/ENet/caffe-enet/python/caffe')</code> 再 <code>import caffe </code>, 问题终于解决!</p></li></ul></li></ul></li><li><p><code>libcudnn.so.5: cannot open shared object file: No such file or directory</code>, ld 抽风, 需要专门刷新下 cuda 链接路径 :</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo ldconfig /usr/local/cuda-8.0/lib64
</span></span></code></pre></td></tr></table></div></div><ol start=3><li><code>*** SIGSEGV (@0x100000049) received by PID 703 (TID 0x7f52cbb1c9c0) from PID 73; stack trace: ***</code> 或者 <code>Segmentation fault (core dumped)</code>, 可能是 python 层的使用出了问题</li><li>段错误, <code>import caffe</code> 退出后错误, 有可能是用了 opencv contrib 的 <code>LIBRARY</code>, 在 <code>Makefile</code> 里删掉 <code>opencv_videoc</code> 什么的&mldr;</li></ol><h2 id=推荐安装方法>推荐安装方法</h2><p>使用 CMake 来安装，推荐 ubuntu16.04 + gcc5.4 + python2.7 + CUDA8.0 + opencv3.4 + protobuf2.6</p><p>实测 Ubuntu18.04 + gcc7 + python2.7 + CUDA10.2 + opencv3.4 + protobuf 3.11? 可以运行，但不支持 cudnn7.6.5。CUDA10.0 + cudnn7.3.1可以正常运作。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/caffe/>Caffe</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/gfpgan%E5%B0%9D%E8%AF%95/><div class=article-image><img src=/p/gfpgan%E5%B0%9D%E8%AF%95/GFPGAN1.5cc13d88917ba0a95067b87c7186d50e_hua19e7be9ff06dc72a46a8fa9c415a192_43292_250x150_fill_q75_h2_box_smart1_2.webp width=250 height=150 loading=lazy alt="Featured image of post GFPGAN尝试" data-hash="md5-XME9iJF7oKlQZ7h8cYbVDg=="></div><div class=article-details><h2 class=article-title>GFPGAN尝试</h2></div></a></article><article><a href=/p/%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%90%ABnan%E5%80%BC%E7%9A%84%E5%85%89%E6%B5%81%E5%9B%BE%E5%83%8F/><div class=article-details><h2 class=article-title>如何处理含nan值的光流图像</h2></div></a></article><article class=has-image><a href=/p/%E5%A6%82%E4%BD%95%E6%B6%88%E9%99%A4%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90%E6%97%B6%E7%9A%84%E6%A3%8B%E7%9B%98%E6%95%88%E5%BA%94/><div class=article-image><img src=/p/%E5%A6%82%E4%BD%95%E6%B6%88%E9%99%A4%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90%E6%97%B6%E7%9A%84%E6%A3%8B%E7%9B%98%E6%95%88%E5%BA%94/shot.0f7e8ca44fad4bcbf75bba298a3dfe8c_hua5252ff81ce67ad7cdcf3f8b04f4040e_26936_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 如何消除图像生成时的棋盘效应" data-hash="md5-D36MpE+tS8v3W7opij3+jA=="></div><div class=article-details><h2 class=article-title>如何消除图像生成时的棋盘效应</h2></div></a></article><article><a href=/p/tensorrt%E8%A7%86%E9%A2%91%E6%B5%81%E6%8E%A8%E7%90%86%E9%80%9F%E5%BA%A6%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/><div class=article-details><h2 class=article-title>TensorRT视频流推理速度异常记录</h2></div></a></article><article><a href=/p/%E6%A8%A1%E5%9E%8B%E5%AB%81%E6%8E%A5/><div class=article-details><h2 class=article-title>模型嫁接</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=Lamply/hugo_stack_pages data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 次二小栈</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.23.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="/local.google.fonts.css",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>